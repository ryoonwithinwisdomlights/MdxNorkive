---
title: Next.js 15 + Notion + 캐시 시스템을 실제로 구현하기 위한 단계별 가이드
slug: engineerings-Next-js-15-Notion-캐시-시스템을-실제로-
summary: ''
pageCover: >-
  https://images.unsplash.com/photo-1593062096033-9a26b09da705?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb
notionId: 2251eb5c03378095bcfbe19932b39768
password: ''
type: ENGINEERINGS
sub_type: TIL
category: TIL
tags:
  - caching
favorite: true
date: '2025-07-04'
last_edited_time: '2025-08-09T14:48:00.000Z'
lastEditedDate: 2025-08-09T14:48:00.000Z
draft: false
description: ''
icon: ''
full: false
lastModified: '2025-08-12'
readingTime: 29
wordCount: 5656
status: published
author: ryoonwithinwisdomlights
version: 1.0.0
---





> 🥰 캐슁전략플로우



<strong>✅ Next.js + Notion + 캐싱 전략 전체 플로우 (로컬 vs 운영 + Vercel Cron)</strong>


```typescript
[Client (/blog 접근)]
        │
        ▼
[Next.js 15 App Router → Page Component]
        │
        ▼
[getPosts() 호출]
        │
        ├── (로컬 개발 환경)
        │       │
        │       ▼
        │   [p-memoize / memory-cache 등]
        │       │
        │       └── 캐시 miss 시
        │               │
        │               ▼
        │          [Notion API fetch (notion-client)]
        │
        └── (운영 환경: Vercel)
                │
                ▼
            [Upstash Redis 캐시 확인]
                │
                └── 캐시 miss 시
                        │
                        ▼
                   [Notion API fetch (notion-client)]

────────────────────────────────────────────────────────────

[Vercel Cron Job (10분마다 실행)]
        │
        ▼
[GET /api/cron/update-posts → 내부에서 변경사항 탐지]
        │
        ▼
[변경된 post 블록만 다시 fetch]
        │
        ▼
[Redis 캐시 갱신 (Upstash)]
```



<strong>✅ 요약 포인트</strong>



| <strong>구분</strong>       | <strong>전략</strong>                                        |
| ------------ | --------------------------------------------- |
| <strong>로컬 개발</strong>    | p-memoize, memory-cache, Map 등 in-memory 방식   |</strong></strong>
| <strong>운영 서버</strong>    | Upstash Redis 사용하여 Vercel 환경에서도 지속되는 캐시       |
| <strong>최신화</strong>      | Vercel Cron 으로 10분마다 Notion 데이터 변화 감지 후 캐시 갱신 |</strong></strong>
| <strong>Fallback</strong> | 캐시 miss 시에만 notion-client 직접 호출 (서버 전용)       |


이 로직을 기준으로한 <strong>Next.js 15 + Notion + 캐시 시스템</strong>을 실제로 구현하기 위한 <strong>단계별 가이드는 아래와 같음.</strong>



<strong>✅ 전체 작업 순서 요약</strong>



| <strong>단계</strong> | <strong>목표</strong>                       | <strong>설명</strong>                               |
| ------ | ---------------------------- | ------------------------------------ |
| 1단계    | Upstash Redis 설정             | Vercel에서 쓸 수 있는 클라우드 Redis 인스턴스 준비   |
| 2단계    | Redis 연결 및 캐시 유틸 구현          | 운영환경에서 Redis 캐시를 사용할 수 있게 함수 작성      |
| 3단계    | getPostBlocks 리팩토링           | 캐싱을 포함한 Notion fetch 함수로 리팩토링        |
| 4단계    | 로컬/운영 캐시 전략 분기               | 개발환경에서는 memory-cache, 운영환경은 Redis 사용 |
| 5단계    | Vercel Cron API 만들기          | 주기적으로 Redis 캐시를 갱신할 route 생성         |
| 6단계    | Vercel Cron 설정               | Vercel dashboard에서 10분 주기로 실행되도록 설정  |
| 7단계    | ISR(revalidate) 병행(optional) | 인기 페이지는 자동 갱신되도록 revalidate 속성 활용    |


## <strong>🧩 1단계: Upstash Redis 설정 (Vercel에서 쓸 외부 캐시)</strong>

1. [https://upstash.com](https://upstash.com/) 가입
2. Redis → Create Database
3. REST URL, Token 확인
4. .env.local에 아래 환경변수 추가

```bash
UPSTASH_REDIS_REST_URL=your_upstash_url
UPSTASH_REDIS_REST_TOKEN=your_upstash_token
```


<strong>🧩 2단계: Redis 연결 유틸 생성</strong>


```typescript
// lib/redis.ts
import { Redis } from "@upstash/redis";

export const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL!,
  token: process.env.UPSTASH_REDIS_REST_TOKEN!,
});
```



<strong>🧩 3단계: getPostBlocks 리팩토링</strong>



```typescript
// lib/notion/getPostBlocks.ts
import { NotionAPI } from "notion-client";
import { redis } from "@/lib/redis";

export async function getPostBlocks(pageId: string) {
  const cacheKey = `postBlock_${pageId}`;

  const cached = await redis.get(cacheKey);
  if (cached) return cached;

  const notion = new NotionAPI({
    userTimeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
  });
  const data = await notion.getPage(pageId);

  await redis.set(cacheKey, data, { ex: 600 }); // 10분 TTL
  return data;
}
```



<strong>🧩 4단계: 로컬/운영 캐시 분기 처리</strong>



```typescript
// lib/cache.ts
const memory = new Map();

export async function getCached<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttl = 600
): Promise<T> {
  const isProd = process.env.NODE_ENV === "production";

  if (!isProd) {
    if (memory.has(key)) return memory.get(key);
    const fresh = await fetcher();
    memory.set(key, fresh);
    setTimeout(() => memory.delete(key), ttl * 1000);
    return fresh;
  }

  // 운영에서는 Redis
  const cached = await redis.get<T>(key);
  if (cached) return cached;

  const fresh = await fetcher();
  await redis.set(key, fresh, { ex: ttl });
  return fresh;
}
```



<strong>🧩 5단계: Vercel Cron용 API route 만들기</strong>



```typescript
// app/api/cron/update-posts/route.ts
import { getPostBlocks } from "@/lib/notion/getPostBlocks";
import { redis } from "@/lib/redis";
import { NextResponse } from "next/server";

const postPageIds = ["postid1", "postid2"]; // 변경 감지할 페이지 ID들

export async function GET() {
  for (const id of postPageIds) {
    const data = await getPostBlocks(id);
    await redis.set(`postBlock_${id}`, data, { ex: 600 });
  }

  return NextResponse.json({ status: "refreshed" });
}
```



<strong>🧩 6단계: Vercel Cron 설정</strong>


```json
{
  "path": "/api/cron/update-posts",
  "schedule": "*/10 * * * *"
}
//(10분마다 실행됨)
```



<strong>🧩 7단계: ISR (revalidate = 600) 병행 사용 (선택)</strong>


```bash
// app/blog/page.tsx

export const revalidate = 600; // 페이지 요청 시 10분 경과되면 백그라운드 regenerate

export default async function BlogPage() {
  const posts = await getPosts(); // 내부에서 Redis → Notion 호출
  return <BlogList posts={posts} />;
}
```



<strong>✅ 마무리 체크리스트</strong>



| <strong>항목</strong>                  | <strong>완료 여부</strong> |
| ----------------------- | --------- |
| ✅ Upstash Redis 연동 완료   | ☐         |
| ✅ Redis 캐시 유틸 생성        | ☐         |
| ✅ Notion fetch 캐싱 적용    | ☐         |
| ✅ Vercel/Local 환경 분기 적용 | ☐         |
| ✅ cron route 생성 및 배포    | ☐         |
| ✅ Vercel Cron Job 설정    | ☐         |
| ✅ ISR 적용 (optional)     | ☐         |

