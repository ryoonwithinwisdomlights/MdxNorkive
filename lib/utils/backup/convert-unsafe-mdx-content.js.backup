/**
 * MDX ì½˜í…ì¸  ì•ˆì „ ë³€í™˜ ìœ í‹¸ë¦¬í‹° (JavaScript ë°±ì—… ë²„ì „)
 *
 * ğŸ“‹ íŒŒì¼ ì—­í• :
 * Notionì—ì„œ ê°€ì ¸ì˜¨ MDX ì½˜í…ì¸ ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” JavaScript ê¸°ë°˜ ë³€í™˜ê¸°ì˜ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.
 * TypeScript ë²„ì „ ê°œë°œ ì „ì˜ ì›ë³¸ JavaScript êµ¬í˜„ì²´ë¡œ, ë‹¨ìˆœí•˜ê³  ì§ê´€ì ì¸ í•¨ìˆ˜í˜• ì ‘ê·¼ë²•ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 * ğŸ—ï¸ ì•„í‚¤í…ì²˜: ì›ë³¸ JavaScript êµ¬í˜„ì²´
 *
 * âœ… ì£¼ìš” ì¥ì :
 * 1. ë‹¨ìˆœí•˜ê³  ì§ê´€ì ì¸ êµ¬ì¡°
 *    - í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë° ì ‘ê·¼ë²•
 *    - ë³µì¡í•œ í´ë˜ìŠ¤ êµ¬ì¡° ì—†ìŒ
 *    - ì´í•´í•˜ê¸° ì‰¬ìš´ ì½”ë“œ íë¦„
 *
 * 2. ë¹ ë¥¸ ê°œë°œê³¼ í”„ë¡œí† íƒ€ì´í•‘
 *    - ë³µì¡í•œ ì„¤ê³„ íŒ¨í„´ ì—†ìŒ
 *    - ë¹ ë¥¸ ê¸°ëŠ¥ êµ¬í˜„ ê°€ëŠ¥
 *    - ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
 *
 * 3. ê°€ë²¼ìš´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
 *    - í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ì˜¤ë²„í—¤ë“œ ì—†ìŒ
 *    - í•¨ìˆ˜ í˜¸ì¶œ ìŠ¤íƒë§Œ ì‚¬ìš©
 *    - ìµœì†Œí•œì˜ ë©”ëª¨ë¦¬ ì ìœ 
 *
 * 4. ë¸Œë¼ìš°ì € í˜¸í™˜ì„±
 *    - ìˆœìˆ˜ JavaScriptë¡œ ì‘ì„±
 *    - ì¶”ê°€ ì»´íŒŒì¼ ê³¼ì • ë¶ˆí•„ìš”
 *    - ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥
 *
 * 5. ë””ë²„ê¹… ìš©ì´ì„±
 *    - ë‹¨ìˆœí•œ í•¨ìˆ˜ í˜¸ì¶œ ì²´ì¸
 *    - ëª…í™•í•œ ì‹¤í–‰ íë¦„
 *    - ì˜¤ë¥˜ ì¶”ì  ì‰¬ì›€
 *
 * ğŸ”´ ì£¼ìš” ë¶€ì‘ìš© ë° í•œê³„:
 * 1. íƒ€ì… ì•ˆì „ì„± ë¶€ì¡±
 *    - JavaScriptì˜ ë™ì  íƒ€ì… ì‹œìŠ¤í…œ
 *    - ëŸ°íƒ€ì„ ì˜¤ë¥˜ ê°€ëŠ¥ì„±
 *    - IDE ì§€ì› ì œí•œ
 *
 * 2. í™•ì¥ì„± ì œí•œ
 *    - êµ¬ì¡°í™”ëœ í™•ì¥ ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ
 *    - ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ì½”ë“œ ìˆ˜ì • í•„ìš”
 *    - ëª¨ë“ˆí™”ëœ ì„¤ê³„ ë¶€ì¡±
 *
 * 3. ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€
 *    - í•¨ìˆ˜ ê°„ ì˜ì¡´ì„± ê´€ë¦¬ ì–´ë ¤ì›€
 *    - ì½”ë“œ ì¬ì‚¬ìš©ì„± ì œí•œ
 *    - í…ŒìŠ¤íŠ¸ ì‘ì„± ë³µì¡
 *
 * 4. ì„±ëŠ¥ ìµœì í™” í•œê³„
 *    - ê³ ê¸‰ ìµœì í™” ê¸°ë²• ì ìš© ì–´ë ¤ì›€
 *    - ë©”ëª¨ì´ì œì´ì…˜ êµ¬í˜„ ë³µì¡
 *    - ë³‘ë ¬ ì²˜ë¦¬ êµ¬í˜„ ì–´ë ¤ì›€
 *
 * 5. ì½”ë“œ í’ˆì§ˆ ê´€ë¦¬ ì–´ë ¤ì›€
 *    - ë¦°íŒ… ë„êµ¬ ì œí•œ
 *    - ì½”ë“œ í¬ë§·íŒ… ì¼ê´€ì„± ì–´ë ¤ì›€
 *    - ë¬¸ì„œí™” ë„êµ¬ ì§€ì› ì œí•œ
 *
 * ğŸ¯ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:
 *
 * âœ… ì í•©í•œ ê²½ìš°:
 * - ë¹ ë¥¸ í”„ë¡œí† íƒ€ì´í•‘
 * - ë‹¨ìˆœí•œ ë³€í™˜ ë¡œì§
 * - ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œ ì§ì ‘ ì‹¤í–‰
 * - í•™ìŠµ ë° êµìœ¡ ëª©ì 
 * - ë ˆê±°ì‹œ ì‹œìŠ¤í…œ í˜¸í™˜ì„±
 *
 * âŒ ë¶€ì í•©í•œ ê²½ìš°:
 * - ëŒ€ê·œëª¨ í”„ë¡œì íŠ¸
 * - ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
 * - íŒ€ ê°œë°œ í™˜ê²½
 * - ì¥ê¸° ìœ ì§€ë³´ìˆ˜ í•„ìš”
 * - íƒ€ì… ì•ˆì „ì„±ì´ ì¤‘ìš”í•œ ê²½ìš°
 *
 * ğŸ”§ ì£¼ìš” ê¸°ëŠ¥:
 * 1. ê¸°ë³¸ MDX ì½˜í…ì¸  ì²˜ë¦¬
 * 2. ì½”ë“œ ë¸”ë¡ ë³´í˜¸
 * 3. í…Œì´ë¸” ë¸”ë¡ ìˆ˜ì •
 * 4. ì œëª© ë¸”ë¡ ìˆ˜ì •
 * 5. ì•ˆì „í•˜ì§€ ì•Šì€ íƒœê·¸ ë³€í™˜
 * 6. ë§í¬ ë³€í™˜
 * 7. ì¤‘ì²© ë§í¬ ìˆ˜ì •
 * 8. URL ì¸ì½”ë”© ë””ì½”ë”©
 *
 * ğŸ“Š ì„±ëŠ¥ íŠ¹ì„±:
 * - ì²˜ë¦¬ ì†ë„: ë¹ ë¦„ (ë‹¨ìˆœ í•¨ìˆ˜ í˜¸ì¶œ)
 * - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ë‚®ìŒ (í•¨ìˆ˜ ìŠ¤íƒë§Œ ì‚¬ìš©)
 * - í™•ì¥ì„±: ë‚®ìŒ (êµ¬ì¡°í™”ëœ í™•ì¥ ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ)
 * - ìœ ì§€ë³´ìˆ˜ì„±: ì¤‘ê°„ (ë‹¨ìˆœí•œ êµ¬ì¡°)
 *
 * ğŸš€ ìµœì í™” ê¸°ë²•:
 * - í•¨ìˆ˜ ì¸ë¼ì¸í™”
 * - ë¶ˆí•„ìš”í•œ ë³€ìˆ˜ ì œê±°
 * - ì •ê·œì‹ ìµœì í™”
 * - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì†Œí™”
 */

function processMdxContent(content) {
  return fixNestedLinks(convertUnsafeTags(transformLinks(content)));
}

function decodeUrlEncodedLinks(content) {
  // ë§ˆí¬ë‹¤ìš´ ë§í¬ì—ì„œ URL ì¸ì½”ë”©ëœ í…ìŠ¤íŠ¸ë§Œ ë””ì½”ë”© (URLì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
  return content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
    // ë§í¬ í…ìŠ¤íŠ¸ë§Œ ë””ì½”ë”©, URLì€ ê·¸ëŒ€ë¡œ ìœ ì§€
    const decodedText = decodeURIComponent(text);
    return `[${decodedText}](${url})`;
  });
}

function fixNestedLinks(content) {
  // ì¤‘ì²©ëœ ë§í¬ ë¬¸ì œë§Œ í•´ê²°: <a> íƒœê·¸ ì•ˆì— ë§ˆí¬ë‹¤ìš´ ë§í¬ê°€ ìˆëŠ” ê²½ìš°
  // íŒ¨í„´: <a href="...">[text](url)</a> â†’ <a href="...">text</a>

  // íŒ¨í„´ 1: <a> íƒœê·¸ ì•ˆì˜ [**text**](url) í˜•íƒœë¥¼ **text**ë¡œ ë³€ê²½
  content = content.replace(
    /(<a[^>]*>)(\[(\*\*[^*]+\*\*)\]\([^)]+\))(<\/a>)/g,
    "$1$3$4"
  );

  // íŒ¨í„´ 2: <a> íƒœê·¸ ì•ˆì˜ [**text**](url) í˜•íƒœë¥¼ textë¡œ ë³€ê²½ (ë³¼ë“œ ì œê±°)
  content = content.replace(
    /(<a[^>]*>)(\[\*\*([^*]+)\*\*\]\([^)]+\))(<\/a>)/g,
    "$1$3$4"
  );

  // íŒ¨í„´ 3: <a> íƒœê·¸ ì•ˆì˜ [text](url) í˜•íƒœë¥¼ textë¡œ ë³€ê²½ (ì¼ë°˜ ë§í¬)
  content = content.replace(
    /(<a[^>]*>)(\[([^\]]+)\]\([^)]+\))(<\/a>)/g,
    "$1$3$4"
  );

  return content;
}

/**
 * MDXì—ì„œ ë¬¸ì œê°€ ìˆëŠ” íƒœê·¸ë“¤ì„ ì•ˆì „í•œ ë¬¸ìì—´(HTML ì—”í‹°í‹°)ë¡œ ë³€í™˜
 * ì½”ë“œë¸”ë¡(``` ... ```) ë‚´ë¶€ëŠ” ë³€í™˜í•˜ì§€ ì•ŠìŒ
 */
function convertUnsafeTags(content) {
  let safeContent = content;

  // ì½”ë“œë¸”ë¡ì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ ì„ì‹œ ë§ˆì»¤ë¡œ êµì²´
  const codeBlocks = [];
  let codeBlockIndex = 0;

  // ì½”ë“œë¸”ë¡ì„ ì°¾ì•„ì„œ ì„ì‹œ ë§ˆì»¤ë¡œ êµì²´
  safeContent = safeContent.replace(/```[\s\S]*?```/g, (match) => {
    const marker = `__CODE_BLOCK_${codeBlockIndex}__`;
    codeBlocks[codeBlockIndex] = match;
    codeBlockIndex++;
    return marker;
  });

  // í…Œì´ë¸” ë¸”ë¡ì„ ì •í™•íˆ ê°ì§€í•˜ê³  ì²˜ë¦¬
  safeContent = safeContent.replace(
    /(\|[^|\n]*\|[^|\n]*\|[^|\n]*\n?)+/g,
    (tableMatch) => {
      // í…Œì´ë¸” ë‚´ì˜ ê° ì…€ì—ì„œ íƒœê·¸ë¥¼ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜
      return tableMatch.replace(/\|([^|]*)\|/g, (cellMatch, cellContent) => {
        const safeCellContent = cellContent.replace(
          /<([^>]+)>/g,
          (tagMatch, tagContent) => {
            // í…Œì´ë¸” ë‚´ì—ì„œëŠ” ëª¨ë“  íƒœê·¸ë¥¼ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜
            return `&lt;${tagContent}&gt;`;
          }
        );
        return `|${safeCellContent}|`;
      });
    }
  );

  // 1. ë¹ˆ ì œëª© ìˆ˜ì • - ê°œì„ ëœ ë¡œì§
  safeContent = safeContent.replace(/^#{1,6}\s*$/gm, (match) => {
    // ì œëª© ë ˆë²¨ì„ ìœ ì§€í•˜ë©´ì„œ ê¸°ë³¸ ì œëª© ì¶”ê°€
    const level = match.match(/^#{1,6}/)[0];
    return `${level} ì œëª© ì—†ìŒ`;
  });

  // ì œëª©ì´ ìˆì§€ë§Œ ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜ ê³µë°±ë§Œ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
  safeContent = safeContent.replace(/^#{1,6}\s*([^\n]*)$/gm, (match, title) => {
    const level = match.match(/^#{1,6}/)[0];
    const trimmedTitle = title.trim();

    // ì œëª©ì´ ë¹„ì–´ìˆê±°ë‚˜ ê³µë°±ë§Œ ìˆëŠ” ê²½ìš°
    if (!trimmedTitle || trimmedTitle === "") {
      return `${level} ì œëª© ì—†ìŒ`;
    }

    // ì œëª©ì´ ë„ˆë¬´ ì§§ê³  ì˜ë¯¸ê°€ ì—†ëŠ” ê²½ìš° (1-2ì ì´í•˜)
    if (trimmedTitle.length <= 2 && !/^[a-zA-Zê°€-í£0-9]/.test(trimmedTitle)) {
      return `${level} ì œëª© ì—†ìŒ`;
    }

    return match; // ì›ë³¸ ì œëª© ìœ ì§€
  });

  // 2. ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì•ˆì „í•œ HTML íƒœê·¸ë¡œ ë³€í™˜
  // **bold** â†’ <strong>bold</strong> (ì—¬ëŸ¬ ì¤„ì— ê±¸ì¹œ ê²½ìš°ë„ ì²˜ë¦¬)
  safeContent = safeContent.replace(
    /\*\*([^*\n]+)\*\*/g,
    "<strong>$1</strong>"
  );
  // *italic* â†’ <em>italic</em> (ì—¬ëŸ¬ ì¤„ì— ê±¸ì¹œ ê²½ìš°ë„ ì²˜ë¦¬)
  safeContent = safeContent.replace(/\*([^*\n]+)\*/g, "<em>$1</em>");
  // `code` â†’ <code>code</code>
  safeContent = safeContent.replace(/`([^`\n]+)`/g, "<code>$1</code>");

  // 3. HTML ì—”í‹°í‹°ë¡œ ì¸ì½”ë”©ëœ íƒœê·¸ë¥¼ ì‹¤ì œ íƒœê·¸ë¡œ ë³€í™˜
  safeContent = safeContent.replace(/&lt;em&gt;/g, "<em>");
  safeContent = safeContent.replace(/&lt;\/em&gt;/g, "</em>");
  safeContent = safeContent.replace(/&lt;strong&gt;/g, "<strong>");
  safeContent = safeContent.replace(/&lt;\/strong&gt;/g, "</strong>");
  safeContent = safeContent.replace(/&lt;code&gt;/g, "<code>");
  safeContent = safeContent.replace(/&lt;\/code&gt;/g, "</code>");

  // 4. ë‹«íˆì§€ ì•Šì€ íƒœê·¸ ì²˜ë¦¬
  // ë‹«íˆì§€ ì•Šì€ <em> íƒœê·¸ ì²˜ë¦¬
  safeContent = safeContent.replace(/<em>([^<]*?)(?=\n|$)/g, "<em>$1</em>");
  // ë‹«íˆì§€ ì•Šì€ <strong> íƒœê·¸ ì²˜ë¦¬
  safeContent = safeContent.replace(
    /<strong>([^<]*?)(?=\n|$)/g,
    "<strong>$1</strong>"
  );
  // ë‹«íˆì§€ ì•Šì€ <code> íƒœê·¸ ì²˜ë¦¬
  safeContent = safeContent.replace(
    /<code>([^<]*?)(?=\n|$)/g,
    "<code>$1</code>"
  );

  // 5. ë§ˆí¬ë‹¤ìš´ ì¸ìš©ë¬¸ ë³´í˜¸ (HTML íƒœê·¸ ì²˜ë¦¬ ì „ì— ì„ì‹œ ë§ˆì»¤ë¡œ êµì²´)
  const blockquotes = [];
  let blockquoteIndex = 0;

  // ë§ˆí¬ë‹¤ìš´ ì¸ìš©ë¬¸ì„ ì„ì‹œ ë§ˆì»¤ë¡œ êµì²´
  safeContent = safeContent.replace(/^>\s*(.+)$/gm, (match, content) => {
    const marker = `__BLOCKQUOTE_${blockquoteIndex}__`;
    blockquotes[blockquoteIndex] = match;
    blockquoteIndex++;
    return marker;
  });

  // ì¼ë°˜ í…ìŠ¤íŠ¸ì—ì„œ <ë¡œ ì‹œì‘í•˜ê³  >ë¡œ ëë‚˜ëŠ” ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬ (ë” í¬ê´„ì )
  safeContent = safeContent.replace(/<([^>]+)>/g, (match, tagContent) => {
    // íƒœê·¸ ë‚´ìš©ì—ì„œ ì²« ë²ˆì§¸ ë‹¨ì–´ë¥¼ íƒœê·¸ëª…ìœ¼ë¡œ ì¶”ì¶œ (ê³µë°±, ë”°ì˜´í‘œ, ë“±í˜¸ ë“±ì„ ê³ ë ¤)
    const tagContentFirst = tagContent.trim().split(/[\s='"]+/)[0];
    const tagName = tagContentFirst.toLowerCase();

    // MDXì—ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” HTML íƒœê·¸ë“¤
    const SELECTORS = [
      // ì œëª© íƒœê·¸
      "h1",
      "h2",
      "h3",
      "h4",
      "h5",
      "h6",

      // í…ìŠ¤íŠ¸ ê´€ë ¨
      "p",
      "span",
      "div",
      "br",
      "hr",
      "strong",
      "b",
      "em",
      "i",
      "u",
      "s",
      "del",
      "ins",
      "mark",
      "small",
      "sub",
      "sup",

      // ë§í¬
      "a",

      // ì¸ìš©
      "blockquote",
      "cite",

      // ì½”ë“œ
      "code",
      "pre",
      "kbd",
      "samp",
      "var",

      // ëª©ë¡
      "ul",
      "ol",
      "li",
      "dl",
      "dt",
      "dd",

      // í…Œì´ë¸”
      "table",
      "thead",
      "tbody",
      "tfoot",
      "tr",
      "td",
      "th",
      "caption",
      "colgroup",
      "col",

      // ë¯¸ë””ì–´
      "img",
      "video",
      "audio",
      "source",
      "track",
      "figure",
      "figcaption",

      // í¼ ìš”ì†Œ (ì¼ë¶€)
      "form",
      "input",
      "textarea",
      "select",
      "option",
      "optgroup",
      "button",
      "label",
      "fieldset",
      "legend",

      // ê¸°íƒ€
      "details",
      "summary",
      "dialog",
      "menu",
      "menuitem",
      "abbr",
      "acronym",
      "address",
      "article",
      "aside",
      "footer",
      "header",
      "main",
      "nav",
      "section",
      "time",
      "data",
      "meter",
      "progress",

      // SVG (ê¸°ë³¸)
      "svg",
      "path",
      "circle",
      "rect",
      "line",
      "polyline",
      "polygon",
      "ellipse",
      "text",
      "g",
      "defs",
      "use",

      // MathML (ê¸°ë³¸)
      "math",
      "mrow",
      "mi",
      "mo",
      "mn",
      "msup",
      "msub",
      "msubsup",
      "mfrac",
      "msqrt",
      "mroot",

      // ê¸°íƒ€ ì•ˆì „í•œ íƒœê·¸ë“¤
      "ruby",
      "rt",
      "rp",
      "bdi",
      "bdo",
      "wbr",
      "nobr",
      "spacer",
      "embed",
      "object",
      "param",
      "map",
      "area",
      //ì»¤ìŠ¤í…€
      "YoutubeWrapper",
      "EmbededWrapper",
      "FileWrapper",
      "GoogleDriveWrapper",
      "BookMarkWrapper",
    ];

    // 1. í—ˆìš©ëœ HTML íƒœê·¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
    if (SELECTORS.includes(tagName) || SELECTORS.includes(tagContentFirst)) {
      return match;
    }

    // 2. í—ˆìš©ëœ íƒœê·¸ì— JSX ì†ì„±ì´ ìˆëŠ” ê²½ìš° í—ˆìš© (className, id, style ë“±)
    if (
      SELECTORS.includes(tagName) &&
      (tagContent.includes("className=") ||
        tagContent.includes("id=") ||
        tagContent.includes("style=") ||
        tagContent.includes("src=") ||
        tagContent.includes("href=") ||
        tagContent.includes("alt=") ||
        tagContent.includes("target=") ||
        tagContent.includes("rel=") ||
        tagContent.includes("onClick=") ||
        tagContent.includes("onChange=") ||
        tagContent.includes("value=") ||
        tagContent.includes("type=") ||
        tagContent.includes("placeholder=") ||
        tagContent.includes("disabled=") ||
        tagContent.includes("required=") ||
        tagContent.includes("checked=") ||
        tagContent.includes("selected=") ||
        tagContent.includes("readonly=") ||
        tagContent.includes("maxlength=") ||
        tagContent.includes("minlength=") ||
        tagContent.includes("pattern=") ||
        tagContent.includes("autocomplete=") ||
        tagContent.includes("autofocus=") ||
        tagContent.includes("form=") ||
        tagContent.includes("name=") ||
        tagContent.includes("tabindex=") ||
        tagContent.includes("title=") ||
        tagContent.includes("data-") ||
        tagContent.includes("aria-"))
    ) {
      return match;
    }

    // 3. ë‹«ëŠ” íƒœê·¸ëŠ” í—ˆìš©ëœ íƒœê·¸ë§Œ í—ˆìš© (</tag>)
    if (tagContent.startsWith("/")) {
      const closingTagName = tagContent.substring(1).toLowerCase();
      const closingTagOriginal = tagContent.substring(1);
      if (
        SELECTORS.includes(closingTagName) ||
        SELECTORS.includes(closingTagOriginal)
      ) {
        return match;
      }
    }

    // 4. ê·¸ ì™¸ì˜ ëª¨ë“  ê²ƒì€ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜
    return `&lt;${tagContent}&gt;`;
  });

  // MDX í™•ì¥ ë¬¸ë²• ì œê±°
  safeContent = safeContent.replace(/\{:[^}]+\}/g, "");

  // ì½”ë“œë¸”ë¡ì„ ì›ë˜ëŒ€ë¡œ ë³µì›
  for (let i = codeBlocks.length - 1; i >= 0; i--) {
    const marker = `__CODE_BLOCK_${i}__`;
    const codeBlock = codeBlocks[i];
    // ë‹¨ìˆœ ë¬¸ìì—´ êµì²´ë¡œ ì¤„ë°”ê¿ˆ ë³´ì¡´
    safeContent = safeContent.split(marker).join(codeBlock);
  }

  // ë§ˆí¬ë‹¤ìš´ ì¸ìš©ë¬¸ ë³µì›
  for (let i = blockquotes.length - 1; i >= 0; i--) {
    const marker = `__BLOCKQUOTE_${i}__`;
    const blockquote = blockquotes[i];
    // ë‹¨ìˆœ ë¬¸ìì—´ êµì²´ë¡œ ì¤„ë°”ê¿ˆ ë³´ì¡´
    safeContent = safeContent.split(marker).join(blockquote);
  }

  return safeContent;
}

function transformLinks(content) {
  let safeContent = content;
  safeContent = transformYouTubeLinks(safeContent);
  safeContent = transformEmbededLinks(safeContent);
  safeContent = transformFileLinks(safeContent);
  safeContent = transformGoogleDriveLinks(safeContent);
  safeContent = transformBookMarkLinks(safeContent);
  return safeContent;
}

function transformGoogleDriveLinks(content) {
  return content.replace(
    /\[([^\]]+)\]\((https?:\/\/drive\.google\.com\/file\/d\/[^\s)]+)\)/g,
    (match, linkText, url) => {
      return `<GoogleDriveWrapper names={"${linkText}"} urls={"${url}"} />`;
    }
  );
}

/**
 * ë¬¸ì„œ ë§í¬ë¥¼ FileWrapper ì»´í¬ë„ŒíŠ¸ë¡œ ë³€í™˜ (PDF, DOC, DOCX, RTF, TXT ë“±)
 * [íŒŒì¼ëª….pdf](URL) â†’ <FileWrapper names={"íŒŒì¼ëª….pdf"} urls={"URL"} />
 * [íŒŒì¼ëª….docx](URL) â†’ <FileWrapper names={"íŒŒì¼ëª….docx"} urls={"URL"} />
 */
function transformFileLinks(content) {
  // ì§€ì›í•˜ëŠ” ë¬¸ì„œ í™•ì¥ìë“¤
  const documentExtensions = [
    "pdf",
    "doc",
    "docx",
    "rtf",
    "txt",
    "md",
    "odt",
    "PDF",
    "DOC",
    "DOCX",
    "RTF",
    "TXT",
    "MD",
    "ODT",
  ];

  // ë¬¸ì„œ ë§í¬ íŒ¨í„´ ë§¤ì¹­: [íŒŒì¼ëª….í™•ì¥ì](URL)
  return content.replace(
    /\[([^\]]+\.(pdf|doc|docx|rtf|txt|md|odt))\]\(([^)]+)\)/gi,
    (match, fileName, extension, url) => {
      // í™•ì¥ìë¥¼ í¬í•¨í•œ ì „ì²´ íŒŒì¼ëª… ìœ ì§€
      return `<FileWrapper names={"${fileName}"} urls={"${url}"} />`;
    }
  );
}

/**
 * YouTube ë§í¬ë¥¼ YoutubeWrapper ì»´í¬ë„ŒíŠ¸ë¡œ ë³€í™˜
 * [video](https://youtu.be/VIDEO_ID) â†’ <YoutubeWrapper names={"video"} urls={"https://youtu.be/VIDEO_ID"} />
 */
function transformYouTubeLinks(content) {
  // YouTube ë§í¬ íŒ¨í„´ ë§¤ì¹­ (youtu.be, youtube.com, youtube-nocookie.com ë“±)
  // [video](https://youtu.be/VIDEO_ID?si=VIDEO_ID) â†’ <YoutubeWrapper names={"video"} urls={"https://youtu.be/VIDEO_ID"} />
  // [video] í…ìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ ë³€í™˜
  return content.replace(
    /\[video\]\((https?:\/\/(www\.)?(youtube\.com|youtu\.be|youtube-nocookie\.com)\/[^\s)]+)\)/g,
    (match, url) => {
      // URLì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±° (si= ë“±)
      const cleanUrl = url.split("?")[0];
      return `<YoutubeWrapper names={"video"} urls={"${cleanUrl}"} />`;
    }
  );
}

function transformBookMarkLinks(content) {
  return content.replace(
    /\[bookmark\]\((https?:\/\/[^\s)]+)\)/g,
    (match, url) => {
      return `<BookMarkWrapper names={"bookmark"} urls={"${url}"} />`;
    }
  );
}

function transformEmbededLinks(content) {
  return content.replace(/\[embed\]\((https?:\/\/[^\s)]+)\)/g, (match, url) => {
    return `<EmbededWrapper names={"embed"} urls={"${url}"} />`;
  });
}

module.exports = {
  processMdxContent,
  convertUnsafeTags,
  decodeUrlEncodedLinks,
  transformYouTubeLinks,
  transformFileLinks,
};
